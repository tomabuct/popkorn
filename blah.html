<html>
<head>
<!-- Import JavaScript Libraries. -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript" src="swfobject.js"></script>
<script type="text/javascript" src="web_socket.js"></script>

<script type="text/javascript" src="swfobject.js"></script>    
 <div id="ytapiplayer">
   You need Flash player 8+ and JavaScript enabled to view this video.
 </div>
<script type="text/javascript">

  function onYouTubePlayerReady(playerId) {
    ytplayer = document.getElementById("myytplayer");
    ytplayer.addEventListener("onStateChange", "onytplayerStateChange");
  }

  function onytplayerStateChange(newState) {
    console.log(newState);
    if (newState == 1) 
      ws.send("play");
    if (newState == 2)
      ws.send("pause;" + parseInt(ytplayer.getCurrentTime()));
    if (newState == 5)
      ws.send("play");
  }

  var params = { allowScriptAccess: "always" };
  var atts = { id: "myytplayer" };
  swfobject.embedSWF("http://www.youtube.com/v/ZPPdetZTOx0?enablejsapi=1&playerapiid=ytplayer&version=3",
                     "ytapiplayer", "425", "356", "8", null, null, params, atts);


  // Let the library know where WebSocketMain.swf is:
  WEB_SOCKET_SWF_LOCATION = "WebSocketMain.swf";

  // Write your code in the same way as for native WebSocket:
  ws = new WebSocket("ws://localhost:8080/");
  ws.onopen = function() {
  };
  ws.onmessage = function(e) {
    console.log(e.data);
    // Receives a message.
    if (e.data == "play") {
      ytplayer.playVideo();
    } 
    if (/pause;/.test(e.data)){
      thresh = 1.5;
      split = e.data.split(";");
      t = parseInt(split[1])
      if (t > ytplayer.getCurrentTime() + thresh || t < ytplayer.getCurrentTime() - thresh) {
        ytplayer.seekTo(t);
      }
      if (ytplayer.getPlayerState() != 3)
        ytplayer.pauseVideo();
    }
    
  };
  ws.onclose = function() {
    alert("closed");
  };

</script>
</head>
<body>
</body>
</html>
