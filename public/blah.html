<html>
<head>
<!-- Import JavaScript Libraries. -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript" src="swfobject.js"></script>
<script src="http://js.pusher.com/1.12/pusher.min.js" type="text/javascript"></script>
 <div id="ytapiplayer">
   You need Flash player 8+ and JavaScript enabled to view this video.
 </div>
<script type="text/javascript">

  function onYouTubePlayerReady(playerId) {
    ytplayer = document.getElementById("myytplayer");
    ytplayer.addEventListener("onStateChange", "onytplayerStateChange");
  }


  var params = { allowScriptAccess: "always" };
  var atts = { id: "myytplayer" };
  swfobject.embedSWF("http://www.youtube.com/v/ZPPdetZTOx0?enablejsapi=1&playerapiid=ytplayer&version=3",
                     "ytapiplayer", "425", "356", "8", null, null, params, atts);


  // Enable pusher logging - don't include this in production
  Pusher.log = function(message) {
    if (window.console && window.console.log) window.console.log(message);
  };

  // Flash fallback logging - don't include this in production
  WEB_SOCKET_DEBUG = true;

  var pusher = new Pusher('86baf974dd9fd950a9c8');
  channel = pusher.subscribe('private-together');
  channel.bind('pusher:subscription_error', function(data) {
    console.log(data)
  });
  channel.bind('client-play', function(data) {
    ytplayer.playVideo();
  });

  channel.bind('client-pause', function(data) {
      thresh = 1.5;
      split = data.time
      t = parseInt(split[1])
      if (t > ytplayer.getCurrentTime() + thresh || t < ytplayer.getCurrentTime() - thresh) {
        ytplayer.seekTo(t);
      }
      if (ytplayer.getPlayerState() != 3)
        ytplayer.pauseVideo();
  });

  function onytplayerStateChange(newState) {
    console.log(newState);
    if (newState == 1) 
      channel.trigger("client-play", {});
    if (newState == 2)
      channel.trigger("client-pause", { time: ytplayer.getCurrentTime() });
    if (newState == 5)
      channel.trigger("client-play", {});
  }
</script>
</head>
<body>
</body>
</html>
